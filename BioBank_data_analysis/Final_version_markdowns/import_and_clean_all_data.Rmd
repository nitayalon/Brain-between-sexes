---
title: "BioBank data analysis - Import"
author: "Nitay Alon"
date: "7/2/2019"
output: html_document
---

This markdown file contains a set of functions and scripts required for importing and data cleansing of the BioBank data set.
```{r load libraries, include=FALSE}
library(dplyr)
library(magrittr)
library(ggplot2)
library(Jmisc)
library(pbapply)
library(effsize)
library(mixtools)
library(DescTools)
source("~/Human_brain_research/Mixture_models/source_script.R")
sourceAll("~/Human_brain_research/Mixture_models/Log_normal_mixture_model/Grid_Search/llk_computation/")
sourceAll("~/Human_brain_research/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/")
sourceAll("~/Human_brain_research/Mixture_models/Log_normal_mixture_model/Grid_Search/llk_computation/")
sourceAll("~/Human_brain_research/BioBank_data_analysis/Hypothesis_testing_methods/")
```

```{r load BioBank data, include=FALSE, warning=FALSE}
bio_bank_data <- read.csv("~/Human_brain_research/Data/Biobank/ukb24562.csv",header = T, stringsAsFactors = F)
```

```{r biobank raw data feature names, include=FALSE, warning=FALSE}
columns_names <- read.csv("~/Human_brain_research/Data/Biobank/convertcsv.csv", header = T, stringsAsFactors = F)
names(bio_bank_data) = columns_names$Description
```

```{r april 2020 update}
daphna_names <- read.delim("~/Desktop/columns_names.txt",header = F)
original_names <- read.delim("~/Desktop/columns_names_original.txt",header = F)
length(daphna_names$V1)
length(original_names$V1)
length(intersect(list.of.names,daphna_names$V1)) - length(list.of.names)
```


```{r filter relevant features}
relevant_region <- c(seq(45,167)
                     ,seq(177,194)
                     ,seq(195,333))
demographic_data <- bio_bank_data[,c(2,3,seq(13,15))]
names(demographic_data) <- c("Sex","Year_Of_Birth",
                             "Ethnic_BG_1",
                             "Ethnic_BG_2",
                             "Ethnic_BG_3")
full_relevant_data <- cbind(demographic_data, relevant_data)
```

```{r demographic data analysis}
full_relevant_data %>% 
  mutate(age = 2019 - Year_Of_Birth) %>% 
  group_by(Sex) %>% 
  summarise(avg = mean(age), std = sd(age), count = n(), min = min(age), max = max(age))
```
```{r addin ethnicity analysis}
22063 / length(demographic_data$Ethnic_BG_1)
```


```{r list of features names}
filtered_bio_bank_data <- bio_bank_data[,names(bio_bank_data) != ""]
total.brain.volume.data <- filtered_bio_bank_data %>% 
  select("Volume of brain, grey+white matter","Volume of ventricular cerebrospinal fluid")
names(filtered_bio_bank_data)[1] <- "eid"
user_data <- select(filtered_bio_bank_data, eid, Sex)
relevant_data <- bio_bank_data[,names(bio_bank_data) %in% daphna_names$V1]
list.of.names <- names(relevant_data)
length(intersect(list.of.names,daphna_names$V1))
```

```{r}
user_data %>% group_by(Sex) %>% summarise(count = n())
```

# Preparing the data sets

First data set - log, winsorized, residuals, standardize.
```{r residual brain size using regression, include=FALSE}
biobank_residuals_data <- list()
biobank_residuals_data <- pblapply(list.of.names,function(x){
methodHelperOfResidualComputation(x,user_data,total.brain.volume.data)
})
names(biobank_residuals_data) <- list.of.names
save(biobank_residuals_data, file = "~/Desktop/BioBank_residual_data.RData")
```

Second data set - log, winsorized, standardize.
```{r normalizing brain feature data, include=FALSE}
biobank_standardized_data <- list()
biobank_standardized_data <- pblapply(list.of.names,function(x){
methodHelperFeatureNormalization(x,user_data)
})
names(biobank_standardized_data) <- list.of.names
save(biobank_standardized_data, file = "~/Desktop/BioBank_standardized_data.RData")
```

Third data set - log, winsorized, residuals, normalized

```{r normalizing brain feature data, include=FALSE}
biobank_normalized_residuals_data <- list()
biobank_normalized_residuals_data <- pblapply(list.of.names,function(x){
methodHelperOfResidualComputation(x,user_data,total.brain.volume.data,
                                  winsorized = T,
                                  normalized = T)
})
names(biobank_normalized_residuals_data) <- list.of.names
save(biobank_normalized_residuals_data, file = "~/Desktop/Biobank_normalized_residuals_data.RData")
```

Next edit the code for EM computation and apply it on both data sets

```{r testing the function}
BrainFeatureAnalysis(biobank_residuals_data$`Mean FA in middle cerebellar peduncle on FA skeleton`)
```

# EM analysis

```{r apply full analysis cycle over residuals}
biobank_feature_residual_analysis <- list()

biobank_feature_residual_analysis <- pblapply(biobank_residuals_data,function(x){
  BrainFeatureAnalysis(x)
})
names(biobank_feature_residual_analysis) <- list.of.names
save(biobank_feature_residual_analysis, file = "~/Desktop/biobank_feature_residual_analysis.RData")
```


```{r apply full analysis cycle over normalized}
biobank_feature_standard_analysis <- list()

biobank_feature_standard_analysis <- pblapply(biobank_standardized_data,function(x){
  BrainFeatureAnalysis(x, including_equal_mixture_model = F)
})
names(biobank_feature_standard_analysis) <- list.of.names
save(biobank_feature_standard_analysis, file = "~/Desktop/biobank_feature_standard_analysis.RData")
```


```{r apply full analysis cycle over normalized}
biobank_feature_normalized_analysis <- list()

biobank_feature_normalized_analysis <- pblapply(biobank_normalized_residuals_data,function(x){
  BrainFeatureAnalysis(x)
})
names(biobank_feature_normalized_analysis) <- list.of.names
save(biobank_feature_normalized_analysis, file = "~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_normalized_analysis.RData")
```
