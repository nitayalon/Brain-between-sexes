---
title: "Exploring the distribution of gender proportions in mixture model"
author: "Nitay Alon"
date: "2/28/2019"
output: html_document
---

In this report we explore the joint distribution (structure) of the mixture proportions of brain features volumes. In the first section a short explanation on the meaning of the proportions is given followed by a set of plots exploring the structure of these variables. 

# Gender preference proprtions
The mixture model assumes that the distribution of each brain feature measures is a mixture of 2 underline normal distributions (assuming unequal variance and mean). Since the data is scaled one of those distributions will have a mean over 0 and the other one below it. 

In turn each gender "selects" the proportion of high mean distribution and low mean distribution, denoted $p,q$ in this report. The goal of this report is to explore the distribution of these proportions.

# Joint distribution of proportions:
```{r fit quadrant, warning=FALSE,include=FALSE}
fitQuadrant <- function(p,q)
{
  p_tilde <- as.numeric(p) - 0.5
  q_tilde <- as.numeric(q) - 0.5
  if(sign(p_tilde) == sign(q_tilde))
  {
    return("Main")
  }
  return("Anti")
}
```

```{r sourcing methods, warning=FALSE,include=FALSE}
library(ggplot2)
library(dplyr)
library(Jmisc)
library(config)
```

```{r source data for fdr analysis,warning=FALSE,include=FALSE}
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_residual_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_standard_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/BioBank_residual_data.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/BioBank_standardized_data.RData")
```

# Residual Data

The first analysis is of the residual data.

```{r prepare data for analysis, include = FALSE}
feature_residual_m_parameters <- convertEMProbabiltiesToPQSpace(biobank_feature_residual_analysis)

residual_p_and_q <- sapply(feature_residual_m_parameters, function(x){c(x$p, x$q)})
```

```{r histogram of t-test and cohen-d}
hist(sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate}),
     xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")

hist(sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$t_test_for_difference_between_genders$statistic}),
     xlab = "T-statistic", main = "Histogram of T statistic", sub = "Residual data")

```


## P-Value color schema pure vs mixture

First we add a coloring schema based on the *p-value* of the llrt, when the hypothesis is pure type vs mixture model. 
```{r pure type vs mixture model colouring schema, include=FALSE,warning=FALSE}
pvalue_per_feature_residuals <- pullPvaluePerHypothesis(biobank_feature_residual_analysis)

pvalue_per_feature_df_residuals <- t(pvalue_per_feature_residuals) %>% as.data.frame() 
residuals_p_and_q_df <- residual_p_and_q %>% as.data.frame()

cohens_d_per_feature_residuals <- sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate})

combined_df_resid <- mergeDataFramesByColumnNames(pvalue_per_feature_df_residuals, 
                                                  residuals_p_and_q_df)

combined_df_resid <- rbind(combined_df_resid, cohens_d_per_feature_residuals)
rownames(combined_df_resid) <- c("p_values","p","q","Cohen_D")
```

```{r pure type vs mixture model plotting with colors}
combined_df_long_resid <- combined_df_resid %>% t() %>% as.data.frame()
combined_df_long_resid$bins_of_pv <- cut(combined_df_long_resid$p_values, c(1e-9,1e-8,1e-3,1e-2,1))
```

```{r plot scatter of pv without correction}
ggplot(combined_df_long_resid, aes(p,q, colour = Cohen_D)) + 
  geom_point(aes(shape=bins_of_pv)) + 
  ggtitle("Values of p and q", subtitle = "No correction") + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```

### FDR

The following figure plots the FDR corrected $p-values$, point color indicate feature quadrant, horizontal lines indicate significance levels.
```{r fdr procedure, include = FALSE}
N <- nrow(combined_df_long_resid)
combined_df_long_sorted_residuals <- combined_df_long_resid[order(combined_df_long_resid$p_values,decreasing = F),]
rownames(combined_df_long_sorted_residuals) = rownames(combined_df_long_resid)[order(combined_df_long_resid$p_values,decreasing = F)]
combined_df_long_sorted_residuals$i <- seq(1:N)
combined_df_long_sorted_residuals$bh_pvalue <- with(combined_df_long_sorted_residuals, p_values * i / N)
combined_df_long_sorted_residuals$region <- apply(combined_df_long_sorted_residuals, 1, function(x){fitQuadrant(x[2],x[3])})
```

```{r plot fdr}
ggplot(combined_df_long_sorted_residuals, aes(i,bh_pvalue,colour = region)) + 
  geom_point() +
  geom_hline(yintercept = 0.01) +
  geom_hline(yintercept = 0.05) +
  geom_hline(yintercept = 0.1) +
  ggtitle("FDR p-values")
  # geom_vline(xintercept = 0.5) +
  # geom_abline(slope = 1, intercept = 0)
```

The tables below are the number of significant features, per significance level:

```{r summarize of significant features}
table(combined_df_long_sorted_residuals$bh_pvalue < 0.01)
table(combined_df_long_sorted_residuals$bh_pvalue < 0.05)
table(combined_df_long_sorted_residuals$bh_pvalue < 0.1)
```

To compute the FDR $p-value$ the current p-values are transformed using the formula:
\[
  pv(i) = max_{j \leq i} pv \frac{n}{j} 
\]

```{r fdr pvalues, include = FALSE}
combined_df_long_sorted_residuals$fdr_pv <- 
  sapply(c(1:nrow(combined_df_long_sorted_residuals)), function(i){
    max(combined_df_long_sorted_residuals$bh_pvalue[1:i])
  })
  
combined_df_long_sorted_residuals$bins_for_fdr <- cut(combined_df_long_sorted_residuals$fdr_pv, c(0,1e-2,5e-2,0.1,1))
```


```{r plot fdr pvalues, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals, aes(i,fdr_pv, colour = bins_for_fdr)) + 
   geom_point() +
   ggtitle("FDR pv", subtitle = "color indicate sig level") 
```

## Post hoc analysis of pure-types

Next, we separate the pure types from the mixture model features:
```{r seperate residual pure types}
pure_types_residual_model_table <- 
combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(3,4)],]

write.csv(pure_types_residual_model_table, file = "pure_types_features_residual_data.csv", row.names = T)

pure_types_residual_model_em_results <- biobank_feature_residual_analysis[rownames(pure_types_residual_model_table)]
pure_types_residual_model_table[order(pure_types_residual_model_table$Cohen_D),]
```



```{r fdr p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) +
  geom_point(aes(shape = bins_for_fdr)) +
  scale_shape_manual(values=c(15, 17))+
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "Shape indicate FDR pv") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="red", 
                        mid="white",
                        high="darkblue", space ="Lab" )
```

```{r fdr p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) +
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR <= 0.05") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```
$H_0: p = q$, what is the theoretical distribution of $p,q$ and compare it to the results above. Moreover, there's no reason to compare the correlations
between these features.

```{r sampling at random}
combined_df_long_resid[rownames(combined_df_long_resid) == 
'Volume of grey matter in Lateral Occipital Cortex, superior division (left)',]
combined_df_long_sorted_residuals[rownames(combined_df_long_sorted_residuals) == 
'Volume of grey matter in Lateral Occipital Cortex, superior division (left)',]
```


# Z-score Data

In this section the analysis is conducted on standardized data instead of residual data 

```{r prepare data for analysis, include = FALSE}
standardized_data_m_parameters <- convertEMProbabiltiesToPQSpace(biobank_feature_standard_analysis)

standard_p_and_q <- sapply(standardized_data_m_parameters, function(x){c(x$p, x$q)})
```

```{r histogram of t-test and cohen-d}
hist(sapply(biobank_feature_standard_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate}),
     xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")

hist(sapply(biobank_feature_standard_analysis, function(x){x$hypothesis_results$t_test_for_difference_between_genders$statistic}),
     xlab = "T-statistic", main = "Histogram of T statistic", sub = "Residual data")

```


## P-Value color schema pure vs mixture

First we add a coloring schema based on the *p-value* of the llrt, when the hypothesis is pure type vs mixture model. 
```{r pure type vs mixture model colouring schema, include=FALSE,warning=FALSE}
pvalue_per_feature_standarize <- pullPvaluePerHypothesis(biobank_feature_standard_analysis)

pvalue_per_feature_df_standard <- t(pvalue_per_feature) %>% as.data.frame() 
p_and_q_df_standard <- standard_p_and_q %>% as.data.frame()

cohens_d_per_feature_standard <- sapply(biobank_feature_standard_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate})

combined_df_standard <- mergeDataFramesByColumnNames(pvalue_per_feature_df_standard, p_and_q_df_standard)

combined_df_standard <- rbind(combined_df_standard, cohens_d_per_feature_standard)

rownames(combined_df_standard) <- c("p_values","p","q","Cohen_D")
```

```{r pure type vs mixture model plotting with colors}
combined_df_long_standard <- combined_df_standard %>% t() %>% as.data.frame()
combined_df_long_standard$bins_of_pv <- cut(combined_df_long_standard$p_values, c(0,1e-2,5e-2,1e-1,1))

ggplot(combined_df_long_standard, aes(p,q, colour = Cohen_D)) + 
  geom_point(aes(shape=bins_of_pv)) + 
  ggtitle("Values of p and q", subtitle = "No correction")
```

### FDR

The following figure plots the FDR corrected $p-values$, point color indicate feature quadrant, horizontal lines indicate significance levels.
```{r fdr procedure, include = FALSE}
N <- nrow(combined_df_long_standard)

combined_df_long_sorted_standard <- combined_df_long_standard[order(combined_df_long_standard$p_values,decreasing = F),]
combined_df_long_sorted_standard$i <- seq(1:N)
combined_df_long_sorted_standard$bh_pvalue <- with(combined_df_long_sorted_standard, p_values * i / N)
combined_df_long_sorted_standard$region <- apply(combined_df_long_sorted_standard, 1, function(x){fitQuadrant(x[2],x[3])})
```

```{r plot fdr}
ggplot(combined_df_long_sorted_standard, aes(i,bh_pvalue,colour = region)) + 
  geom_point() +
  geom_hline(yintercept = 0.01) +
  geom_hline(yintercept = 0.05) +
  geom_hline(yintercept = 0.1) +
  ggtitle("FDR p-values")
  # geom_vline(xintercept = 0.5) +
  # geom_abline(slope = 1, intercept = 0)
```

The tables below are the number of significant features, per significance level:

```{r summarize of significant features}
table(combined_df_long_sorted_standard$bh_pvalue < 0.01)
table(combined_df_long_sorted_standard$bh_pvalue < 0.05)
table(combined_df_long_sorted_standard$bh_pvalue < 0.1)
```

To compute the FDR $p-value$ the current p-values are transformed using the formula:
\[
  pv(i) = max_{j \leq i} pv \frac{n}{j} 
\]

```{r fdr pvalues, include = FALSE}
combined_df_long_sorted_standard$fdr_pv <- 
  sapply(c(1:nrow(combined_df_long_sorted_standard)), function(i){
    max(combined_df_long_sorted_standard$bh_pvalue[1:i])
  })
  
combined_df_long_sorted_standard$bins_for_fdr <- cut(combined_df_long_sorted_standard$fdr_pv, c(0,1e-2,5e-2,0.1,1))
```

```{r plot fdr pvalues, warnings = FALSE}
ggplot(combined_df_long_sorted_standard, aes(i,fdr_pv, colour = bins_for_fdr)) + 
   geom_point() +
   ggtitle("FDR pv", subtitle = "color indicate sig level") 
```

```{r seperate log volume pure types}
pure_types_log_volume_model_table <- 
combined_df_long_sorted_standard[combined_df_long_sorted_standard$bins_for_fdr %in% levels(combined_df_long_sorted_standard$bins_for_fdr)[c(3,4)],]

write.csv(pure_types_log_volume_model_table, file = "pure_types_features_log_volume_data.csv", row.names = T)
```


```{r fdr p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_standard[combined_df_long_sorted_standard$bins_for_fdr %in% levels(combined_df_long_sorted_standard$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) + 
  geom_point(aes(shape = bins_for_fdr)) +
  scale_shape_manual(values=c(3, 6, 17, 25))+
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "Shape indicate FDR pv") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```

```{r same plot but without fdr bins p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_standard[combined_df_long_sorted_standard$bins_for_fdr %in% levels(combined_df_long_sorted_standard$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) + 
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR <= 0.05") + 
  geom_abline(slope = 1, intercept = 0) + 
  geom_abline(slope = .5, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab")
```

# Analysis of non signifanct features

Following the discussion from 10/11/2019 we test the non-significant features, at each data set, to see if they are indeed pure types or not.
```{r install relevant library}
# install.packages("TOSTER")
library("TOSTER")
```


```{r extracting pure types feature from each data set}
residual_pure_types_features_names <- combined_df_long_sorted_residuals[which(combined_df_long_sorted_residuals$bh_pvalue > 0.05),] %>% 
  row.names() 
residual_pure_types_features <- biobank_residuals_data[residual_pure_types_features_names]

residual_pure_types_features[[residual_pure_types_features_names[5]]] %>% 
  group_by(sex) %>% 
  summarise(avg = mean(value),
            std = sd(value),
            count = n())

TOSTtwo(m1=0.02148792,
        m2=-0.02424953,
        sd1=1.0031235,
        sd2=0.9959662,
        n1=9501,
        n2=8419,
        low_eqbound_d=-0.1, 
        high_eqbound_d=0.1, 
        alpha = 0.025, 
        var.equal=FALSE)

residual_pure_types_features[[residual_pure_types_features_names[5]]] %>% 
  select(sex,value) %>% 
  ggplot(aes(x = value, fill = factor(sex))) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = c(0.04633958,-0.05172520), linetype="dotted", 
                color = "blue", size=1.5)
```

