---
title: "Exploring the distribution of gender proportions in mixture model"
author: "Nitay Alon"
date: "2/28/2019"
output: html_document
---

In this report we explore the joint distribution (structure) of the mixture proportions of brain features volumes. In the first section a short explanation on the meaning of the proportions is given followed by a set of plots exploring the structure of these variables. 

# Gender preference proprtions
The mixture model assumes that the distribution of each brain feature measures is a mixture of 2 underline normal distributions (assuming unequal variance and mean). Since the data is scaled one of those distributions will have a mean over 0 and the other one below it. 

In turn each gender "selects" the proportion of high mean distribution and low mean distribution, denoted $p,q$ in this report. The goal of this report is to explore the distribution of these proportions.

# Joint distribution of proportions:
```{r fit quadrant, warning=FALSE,include=FALSE}
fitQuadrant <- function(p,q)
{
  p_tilde <- as.numeric(p) - 0.5
  q_tilde <- as.numeric(q) - 0.5
  if(sign(p_tilde) == sign(q_tilde))
  {
    return("Main")
  }
  return("Anti")
}
```

```{r sourcing methods, warning=FALSE,include=FALSE}
library(ggplot2)
library(dplyr)
library(Jmisc)
library(config)
library(magrittr)
```

```{r source data for fdr analysis,warning=FALSE,include=FALSE}
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_residual_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_standard_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/BioBank_residual_data.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/BioBank_standardized_data.RData")
```

# Residual Data

The first analysis is of the residual data.

```{r prepare data for analysis, include = FALSE}
feature_residual_m_parameters <- convertEMProbabiltiesToPQSpace(biobank_feature_residual_analysis)
residual_p_and_q <- sapply(feature_residual_m_parameters, function(x){c(x$p, x$q)})
```

```{r histogram of t-test and cohen-d}
hist(sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate}),
     xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")

hist(sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$t_test_for_difference_between_genders$statistic}),
     xlab = "T-statistic", main = "Histogram of T statistic", sub = "Residual data")

```


## P-Value color schema pure vs mixture

First we add a coloring schema based on the *p-value* of the llrt, when the hypothesis is pure type vs mixture model. 
```{r pure type vs mixture model colouring schema, include=FALSE,warning=FALSE}
pvalue_per_feature_residuals <- pullPvaluePerHypothesis(biobank_feature_residual_analysis)

pvalue_per_feature_df_residuals <- t(pvalue_per_feature_residuals) %>% as.data.frame() 
residuals_p_and_q_df <- residual_p_and_q %>% as.data.frame()

cohens_d_per_feature_residuals <- sapply(biobank_feature_residual_analysis, function(x){x$hypothesis_results$cohen_d_test$estimate})

combined_df_resid <- mergeDataFramesByColumnNames(pvalue_per_feature_df_residuals, 
                                                  residuals_p_and_q_df)

combined_df_resid <- rbind(combined_df_resid, cohens_d_per_feature_residuals)
rownames(combined_df_resid) <- c("p_values","p","q","Cohen_D")
```

```{r pure type vs mixture model plotting with colors}
combined_df_long_resid <- combined_df_resid %>% t() %>% as.data.frame()
combined_df_long_resid$bins_of_pv <- cut(combined_df_long_resid$p_values, c(1e-9,1e-8,1e-3,1e-2,1))
```

```{r plot scatter of pv without correction}
ggplot(combined_df_long_resid, aes(p,q, colour = Cohen_D)) + 
  geom_point(aes(shape=bins_of_pv)) + 
  ggtitle("Values of p and q", subtitle = "No correction") + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```

### FDR

The following figure plots the FDR corrected $p-values$, point color indicate feature quadrant, horizontal lines indicate significance levels.
```{r fdr procedure, include = FALSE}
N <- nrow(combined_df_long_resid)
combined_df_long_sorted_residuals <- combined_df_long_resid[order(combined_df_long_resid$p_values,decreasing = F),]
rownames(combined_df_long_sorted_residuals) = rownames(combined_df_long_resid)[order(combined_df_long_resid$p_values,decreasing = F)]
combined_df_long_sorted_residuals$i <- seq(1:N)
combined_df_long_sorted_residuals$bh_pvalue <- with(combined_df_long_sorted_residuals, p_values * i / N)
combined_df_long_sorted_residuals$region <- apply(combined_df_long_sorted_residuals, 1, function(x){fitQuadrant(x[2],x[3])})
```

```{r plot fdr}
ggplot(combined_df_long_sorted_residuals, aes(i,bh_pvalue,colour = region)) + 
  geom_point() +
  geom_hline(yintercept = 0.01) +
  geom_hline(yintercept = 0.05) +
  geom_hline(yintercept = 0.1) +
  ggtitle("FDR p-values")
  # geom_vline(xintercept = 0.5) +
  # geom_abline(slope = 1, intercept = 0)
```

The tables below are the number of significant features, per significance level:

```{r summarize of significant features}
table(combined_df_long_sorted_residuals$bh_pvalue < 0.01)
table(combined_df_long_sorted_residuals$bh_pvalue < 0.05)
table(combined_df_long_sorted_residuals$bh_pvalue < 0.1)
```

To compute the FDR $p-value$ the current p-values are transformed using the formula:
\[
  pv(i) = max_{j \leq i} pv \frac{n}{j} 
\]

```{r fdr pvalues, include = FALSE}
combined_df_long_sorted_residuals$fdr_pv <- 
  sapply(c(1:nrow(combined_df_long_sorted_residuals)), function(i){
    max(combined_df_long_sorted_residuals$bh_pvalue[1:i])
  })
  
combined_df_long_sorted_residuals$bins_for_fdr <- cut(combined_df_long_sorted_residuals$fdr_pv, c(0,1e-2,5e-2,0.1,1))
```


```{r plot fdr pvalues, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals, aes(i,fdr_pv, colour = bins_for_fdr)) + 
   geom_point() +
   ggtitle("FDR pv", subtitle = "color indicate sig level") 
```

## Post hoc analysis of pure-types

Next, we separate the pure types from the mixture model features:
```{r seperate residual pure types}
pure_types_residual_model_table <- 
combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(3,4)],]

write.csv(pure_types_residual_model_table, file = "pure_types_features_residual_data.csv", row.names = T)

pure_types_residual_model_em_results <- biobank_feature_residual_analysis[rownames(pure_types_residual_model_table)]
pure_types_residual_model_table[order(pure_types_residual_model_table$Cohen_D),]
```



```{r fdr p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) +
  geom_point(aes(shape = bins_for_fdr)) +
  scale_shape_manual(values=c(15, 17))+
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "Shape indicate FDR pv") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="red", 
                        mid="white",
                        high="darkblue", space ="Lab" )
```

```{r fdr p value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],], aes(p,q, colour = Cohen_D)) +
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR <= 0.05") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```

### Combined data sets plot
This section was added at 26/01/2019

```{r validating data sets sizes}
names(combined_df_resid_equal_probs_sorted)
names(combined_df_long_sorted_residuals)
length(intersect(row.names(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],]),
          combined_df_resid_equal_probs_sorted$feature_name))
length(row.names(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],]))
```

```{r joining the data sets for single plot}
non_pure_types_features_data_set <- combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],]

non_pure_types_features_data_set$feature_name = rownames(non_pure_types_features_data_set)

str(non_pure_types_features_data_set)
combined_df_resid_equal_probs_sorted$feature_name <- as.character(combined_df_resid_equal_probs_sorted$feature_name)

non_pure_types_features_data_set_with_equal_mixture_model_hypothesis <- 
  inner_join(non_pure_types_features_data_set,combined_df_resid_equal_probs_sorted,
             by = 'feature_name')
str(non_pure_types_features_data_set_with_equal_mixture_model_hypothesis)
```

```{r final FDR plot for residuals}
non_pure_types_features_data_set_with_equal_mixture_model_hypothesis %>% 
  select(q = q.x,p = p.x,Cohen_D = Cohen_D.x, p_equal_q, feature_name) %>% 
ggplot(aes(p,q, colour = Cohen_D)) +
  geom_point(aes(shape = p_equal_q)) +
  scale_shape_manual(values=c(3, 19))+
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "shape is p=q hypothesis") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" ) +
  coord_fixed() #+
  #geom_text(aes(label=ifelse(p_equal_q,as.character(feature_name),'')),hjust=0,vjust=0)

```

### Equal mixture vs mixture model

Repeating the same analysis but this time the null hypothesis is $p=q$.

```{r remove the pure types from the list}
biobank_feature_residual_analysis_without_pure_type <- biobank_feature_residual_analysis[!(names(biobank_feature_residual_analysis) %in% row.names(pure_types_residual_model_table))]
```


```{r equal mixture probability vs mixture model, include=FALSE,warning=FALSE}
equal_mixture_probabilities_p_value <- equalProbabilityMixturePV(biobank_feature_residual_analysis_without_pure_type)

pvalue_mixture_vs_equal_prob_pv <- equal_mixture_probabilities_p_value %>% data.frame() 

names(pvalue_mixture_vs_equal_prob_pv) <- "p_value"

residuals_p_and_q_df_equal_probs <- residuals_p_and_q_df[!(names(residuals_p_and_q_df) %in% row.names(pure_types_residual_model_table))] %>% t()

names(residuals_p_and_q_df_equal_probs) <- c("p","q")

combined_df_resid_equal_probs <- base::merge(pvalue_mixture_vs_equal_prob_pv, residuals_p_and_q_df_equal_probs,by = 0, all = T)

names(combined_df_resid_equal_probs) <- c("feature","p_value", "p", "q")

cohens_d_per_feature_residuals_equal_probs <- cohens_d_per_feature_residuals[!(names(cohens_d_per_feature_residuals) %in% row.names(pure_types_residual_model_table))] %>% data.frame()

names(cohens_d_per_feature_residuals_equal_probs) <- "Cohen_D"
cohens_d_per_feature_residuals_equal_probs$feature = row.names(cohens_d_per_feature_residuals_equal_probs)

combined_df_resid_equal_probs <- inner_join(combined_df_resid_equal_probs, cohens_d_per_feature_residuals_equal_probs)
```

```{r validating results}
biobank_feature_residual_analysis_without_pure_type[['Volume of grey matter in Parahippocampal Gyrus, anterior division (left)']] %>% str()
equal_mixture_probabilities_p_value['Volume of grey matter in Parahippocampal Gyrus, anterior division (left)']
combined_df_resid_equal_probs %>% filter(feature == 'Volume of grey matter in Parahippocampal Gyrus, anterior division (left)')
```


```{r pure type vs mixture model plotting with colors}
combined_df_resid_equal_probs$bins_of_pv <- cut(combined_df_resid_equal_probs$p_value, c(1e-9,1e-8,1e-3,1e-2,5e-2,1e-1,1))
```

```{r fdr procedure, include = FALSE}
N <- nrow(combined_df_resid_equal_probs)
combined_df_resid_equal_probs_sorted <- combined_df_resid_equal_probs[order(combined_df_resid_equal_probs$p_value,decreasing = F),]
rownames(combined_df_resid_equal_probs_sorted) = rownames(combined_df_resid_equal_probs_sorted)[order(combined_df_resid_equal_probs$p_value,decreasing = F)]
combined_df_resid_equal_probs_sorted$i <- seq(1:N)
combined_df_resid_equal_probs_sorted$bh_pvalue <- with(combined_df_resid_equal_probs_sorted, p_value * i / N)
combined_df_resid_equal_probs_sorted$region <- apply(combined_df_resid_equal_probs_sorted, 1, function(x){fitQuadrant(x[3],x[4])})
```

```{r summarize of significant features}
table(combined_df_resid_equal_probs_sorted$bh_pvalue < 0.01)
table(combined_df_resid_equal_probs_sorted$bh_pvalue < 0.05)
table(combined_df_resid_equal_probs_sorted$bh_pvalue < 0.1)
```

```{r bh correction for FWER}
combined_df_resid_equal_probs_sorted$fdr_pv <- 
  sapply(c(1:nrow(combined_df_resid_equal_probs_sorted)), function(i){
    max(combined_df_resid_equal_probs_sorted$bh_pvalue[1:i])
  })
  
combined_df_resid_equal_probs_sorted$bins_for_fdr <- cut(combined_df_resid_equal_probs_sorted$fdr_pv, c(0,1e-2,5e-2,0.1,1))
combined_df_resid_equal_probs_sorted$p_equal_q <- combined_df_resid_equal_probs_sorted$bins_for_fdr %in% levels(combined_df_resid_equal_probs_sorted$bins_for_fdr)[c(3,4)]

combined_df_resid_equal_probs_sorted %>% 
  filter(feature == 'Volume of grey matter in Parahippocampal Gyrus, anterior division (left)')
```

```{r plot FDR bins for pure mixture vs mosaic mixture }
ggplot(combined_df_resid_equal_probs_sorted, aes(p,q, colour = Cohen_D)) +
  geom_point(aes(shape = p_equal_q)) +
  scale_shape_manual(values=c(3, 19))+
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "shape is p=q hypothesis") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" ) +
  coord_fixed()
```

#### Selecting extreme gender oriented features
```{r p equal q features, include=FALSE}
single_mixture_model_features <- combined_df_resid_equal_probs_sorted[combined_df_resid_equal_probs_sorted$p_equal_q,]
write.csv(single_mixture_model_features, "equal_mixture_model_features_residuals.csv")
```


# Analysis of non signifanct features

# 23/12/2019
```{r fdr logit value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)],], aes(log(p / (1-p)),log(q/(1-q)), colour = Cohen_D)) +
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR <= 0.05") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```

```{r fdr logit value by quadrant, warnings = FALSE}
ggplot(combined_df_long_sorted_residuals[combined_df_long_sorted_residuals$bins_for_fdr %in% levels(combined_df_long_sorted_residuals$bins_for_fdr)[c(1,2)] & abs(combined_df_long_sorted_residuals$Cohen_D) > 0.1,], aes(log(p/(1-p)),log(q/(1-q)), colour = Cohen_D)) +
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR <= 0.05") + 
  geom_abline(slope = 1, intercept = 0) + 
  scale_color_gradient2(midpoint=0, 
                        low="darkblue", 
                        mid="yellow",
                        high="red", space ="Lab" )
```
