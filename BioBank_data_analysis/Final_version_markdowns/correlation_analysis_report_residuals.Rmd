---
title: "Correlation analysis of responsebilites"
author: "Nitay Alon"
date: "May 17, 2019"
output: html_document
---

In the E-step of the EM algorithm we compute the above conditional probabilities. The first step is to extract these probabilities and create a new table of id and probabilities.

```{r load methods, include=FALSE}
library(pbapply)
library(corrplot)
```

```{r load data, include=FALSE}
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_residual_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_standard_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/combined_df_long_sorted_residuals.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/combined_df_long_sorted_standardize.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/colomns_name.RData")
```

# Residual data

## Pure types
In this section we compute corelation matrix for pure types features only
```{r pure types features, include=FALSE}
pure_type_features_residuals <- biobank_feature_residual_analysis[pure_types_features_names]

pure_type_men_data_residuals <- lapply(pure_type_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

pure_type_women_data_residuals <- lapply(pure_type_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})
```

join the tables
```{r create new responsebilities table all data, include=FALSE, warning=FALSE}
pure_type_men_feature_data_residuals <- pure_type_men_data_residuals[[1]]
for(i in 2:length(pure_type_men_data_residuals))
{
  pure_type_men_feature_data_residuals <- base::merge(pure_type_men_feature_data_residuals, pure_type_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_men_feature_data_residuals) <- c("eid", pure_types_features_names_by_type)
pure_type_men_feature_data_residuals_no_id_residuals <- pure_type_men_feature_data_residuals[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
pure_type_women_feature_data_residuals <- pure_type_women_data_residuals[[1]]
for(i in 2:length(pure_type_women_data_residuals))
{
  pure_type_women_feature_data_residuals <- base::merge(pure_type_women_feature_data_residuals, pure_type_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_women_feature_data_residuals) <- c("eid", pure_types_features_names_by_type)
pure_type_women_features_no_id_residuals <- pure_type_women_feature_data_residuals[,-1]
```

```{r order columns by Biobank order}
pure_type_men_feature_data_residuals_no_id_residuals <- pure_type_men_feature_data_residuals_no_id_residuals[order(pure_types_features_names)]
pure_type_women_features_no_id_residuals <- pure_type_women_features_no_id_residuals[order(pure_types_features_names)]
```


```{r correlation matrix by gender pure types, include=FALSE}
pure_type_men_cor_residuals <- cor(pure_type_men_feature_data_residuals_no_id_residuals , use = "pairwise.complete.obs")
pure_type_women_cor_residuals <- cor(pure_type_women_features_no_id_residuals ,use = "pairwise.complete.obs")
pure_type_combined_correaltion_residuals <- pure_type_men_cor_residuals
pure_type_combined_correaltion_residuals[lower.tri(pure_type_combined_correaltion_residuals)] <- pure_type_women_cor_residuals[lower.tri(pure_type_women_cor_residuals)]
```

```{r corrplot names editing}
colnames(pure_type_combined_correaltion_residuals) <- 1:ncol(pure_type_combined_correaltion_residuals)
rownames(pure_type_combined_correaltion_residuals) <- 1:nrow(pure_type_combined_correaltion_residuals)
```


```{r corrplot by name both genders all data}
corrplot(pure_type_combined_correaltion_residuals, method = 'circle',tl.cex = 1.5,tl.srt = 45)
```

## Two mixture model (Full mosaic)

```{r extract FDR significant features all data, include=FALSE}
two_mixture_model_features_residuals <- biobank_feature_residual_analysis[non_equal_probability_mixture_names]

two_mixture_model_men_data_residuals <- lapply(two_mixture_model_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

two_mixture_model_women_data_residuals <- lapply(two_mixture_model_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})
```

join the tables:
```{r create men table all data, include=FALSE, warning=FALSE}
two_mixture_model_men_feature_data_residuals <- two_mixture_model_men_data_residuals[[1]]
for(i in 2:length(two_mixture_model_men_data_residuals))
{
  two_mixture_model_men_feature_data_residuals <- base::merge(two_mixture_model_men_feature_data_residuals, two_mixture_model_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(two_mixture_model_men_feature_data_residuals) <- c("eid", non_equal_probability_mixture_names)
two_mixture_model_men_features_no_id_residuals <- two_mixture_model_men_feature_data_residuals[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
two_mixture_model_women_feature_data_residuals <- two_mixture_model_women_data_residuals[[1]]
for(i in 2:length(two_mixture_model_women_data_residuals))
{
  two_mixture_model_women_feature_data_residuals <- base::merge(two_mixture_model_women_feature_data_residuals, two_mixture_model_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(two_mixture_model_women_feature_data_residuals) <- c("eid", non_equal_probability_mixture_names)
two_mixture_model_women_features_no_id_residuals <- two_mixture_model_women_feature_data_residuals[,-1]
```

```{r separate features by group}
volume_features_mosaic_features <- grep('Volume',non_equal_probability_mixture_names)

weighted_mean_MD_features_mosaic_features <- grep('Weighted-mean MD',non_equal_probability_mixture_names)
MD_features_mosaic_features <- grep('Mean MD',non_equal_probability_mixture_names)[!grep('MD',non_equal_probability_mixture_names) %in%  weighted_mean_MD_features_mosaic_features]

weighted_mean_FA_features_mosaic_features <- grep('Weighted-mean FA',non_equal_probability_mixture_names)
FA_features_mosaic_features <- grep('Mean FA',non_equal_probability_mixture_names)[!grep('FA',non_equal_probability_mixture_names) %in% weighted_mean_FA_features_mosaic_features]
```


```{r correlation matrix by gender all data, include=FALSE}
men_cor_residuals <- cor(men_features_no_id_residuals, use = "pairwise.complete.obs")
women_cor_residuals <- cor(women_features_no_id_residuals,use = "pairwise.complete.obs")
combined_correaltion_residuals <- men_cor_residuals
combined_correaltion_residuals[lower.tri(combined_correaltion_residuals)] <- women_cor_residuals[lower.tri(women_cor_residuals)]
```

```{r preparing the feature names lagend}
two_mixture_model_corrplot_legend <- data.frame(feature_name = colnames(combined_correaltion_residuals), 
                                                number = 1:ncol(combined_correaltion_residuals))
colnames(combined_correaltion_residuals) <- rownames(combined_correaltion_residuals) <- 1:ncol(combined_correaltion_residuals)
```


```{r corrplot of volume features single mixture model}
corrplot(combined_correaltion_residuals[volume_features_mosaic_features,volume_features_mosaic_features], order = "alphabet",tl.cex = 0.4)
```

```{r corrplot of MD features single mixture model}
corrplot(combined_correaltion_residuals[MD_features_mosaic_features,MD_features_mosaic_features], order = "alphabet",
         tl.cex = 1.0,tl.srt = 45)
```

```{r corrplot of weighted mean MD features single mixture model}
corrplot(combined_correaltion_residuals[weighted_mean_MD_features_mosaic_features,weighted_mean_MD_features_mosaic_features], order = "alphabet",
         tl.cex = 1.0,tl.srt = 45)
```


```{r corrplot of FA features single mixture model}
corrplot(combined_correaltion_residuals[FA_features_mosaic_features,FA_features_mosaic_features], order = "alphabet",
         tl.cex = 0.8)
```
```{r corrplot of weighted mean FA features single mixture model}
corrplot(combined_correaltion_residuals[weighted_mean_FA_features_mosaic_features,weighted_mean_FA_features_mosaic_features], order = "alphabet",
         tl.cex = 0.8)
```

## Single mixture model

```{r extract FDR significant features all data, include=FALSE}
single_mixture_model_features_residuals <- biobank_feature_residual_analysis[equal_probability_mixture_names]

men_data_residuals <- lapply(single_mixture_model_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

women_data_residuals <- lapply(single_mixture_model_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})
```

```{r partiton to features all data, include=FALSE}
FA_features_residuals <- c(grep("Mean FA", names(single_mixture_model_features_residuals)),
                 grep("mean FA", names(single_mixture_model_features_residuals)))
MD_features_residuals <- c(grep("Mean MD", names(single_mixture_model_features_residuals)),
                 grep("mean MD", names(single_mixture_model_features_residuals)))
Volume_features_residuals <- c(grep("Volume", names(single_mixture_model_features_residuals)))
feature_order_for_corrplot_residuals <- c(FA_features_residuals, MD_features_residuals, Volume_features_residuals)
```

join the tables:
```{r create men table all data, include=FALSE, warning=FALSE}
men_feature_data_residuals <- men_data_residuals[[1]]
for(i in 2:length(men_data_residuals))
{
  men_feature_data_residuals <- base::merge(men_feature_data_residuals, men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data_residuals) <- c("eid", equal_probability_mixture_names)
men_features_no_id_residuals <- men_feature_data_residuals[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
women_feature_data_residuals <- women_data_residuals[[1]]
for(i in 2:length(women_data_residuals))
{
  women_feature_data_residuals <- base::merge(women_feature_data_residuals, women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data_residuals) <- c("eid", equal_probability_mixture_names)
women_features_no_id_residuals <- women_feature_data_residuals[,-1]
```

## Correlation matrix

```{r correlation matrix by gender all data, include=FALSE}
men_cor_residuals <- cor(men_features_no_id_residuals[,feature_order_for_corrplot_residuals], use = "pairwise.complete.obs")
women_cor_residuals <- cor(women_features_no_id_residuals[,feature_order_for_corrplot_residuals],use = "pairwise.complete.obs")
combined_correaltion_residuals <- men_cor_residuals
combined_correaltion_residuals[lower.tri(combined_correaltion_residuals)] <- women_cor_residuals[lower.tri(women_cor_residuals)]
```

```{r preparing the feature names lagend}
single_mixture_model_corrplot_legend <- data.frame(feature_name = colnames(combined_correaltion_residuals), 
                                                number = 1:ncol(combined_correaltion_residuals))
volume_features_single_mixture_model <- grep('Volume',single_mixture_model_corrplot_legend$feature_name)
MD_features_single_mixture_model <- grep('MD',single_mixture_model_corrplot_legend$feature_name)
FA_features_single_mixture_model <- grep('FA',single_mixture_model_corrplot_legend$feature_name)
colnames(combined_correaltion_residuals) <- rownames(combined_correaltion_residuals) <- 1:ncol(combined_correaltion_residuals)
```


```{r corrplot of volume features single mixture model}
corrplot(combined_correaltion_residuals[volume_features_single_mixture_model,volume_features_single_mixture_model], order = "alphabet",
         tl.cex = 0.8,tl.srt = 45)
```

```{r corrplot of MD features single mixture model}
corrplot(combined_correaltion_residuals[MD_features_single_mixture_model,MD_features_single_mixture_model], order = "alphabet",
         tl.cex = 1.5,tl.srt = 45)
```
```{r corrplot of FA features single mixture model}
corrplot(combined_correaltion_residuals[FA_features_single_mixture_model,FA_features_single_mixture_model], order = "alphabet",
         tl.cex = 1.5,tl.srt = 45)
```

```{r corrplot by eigenvalues both genders all data}
corrplot(combined_correaltion_residuals, title="both genders - full data", order = "FPC",
         tl.cex = 0.1,tl.srt = 45)
```

```{r corrplot by familiy both genders all data}
corrplot(combined_correaltion_residuals[FA_features_residuals,FA_features_residuals], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_residuals[MD_features_residuals,MD_features_residuals], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_residuals[Volume_features_residuals,Volume_features_residuals], method="color", title="Volume",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
```

### Top geneder affected features:
```{r top gender affected features, include=FALSE}
high_gender_effect_features_residuals <- biobank_feature_residual_analysis[top_20_gender_features]

high_gender_men_data_residuals <- lapply(high_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

high_gender_women_data_residuals <- lapply(high_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})

high_gender_effect_men_feature_data_residuals <- high_gender_men_data_residuals[[1]]
for(i in 2:length(high_gender_men_data_residuals))
{
  high_gender_effect_men_feature_data_residuals <- base::merge(high_gender_effect_men_feature_data_residuals, high_gender_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(high_gender_effect_men_feature_data_residuals) <- c("eid", top_20_gender_features)
high_gender_effect_men_feature_data_residuals_no_id <- high_gender_effect_men_feature_data_residuals[,-1]

high_gender_effect_women_feature_data_residuals <- high_gender_women_data_residuals[[1]]
for(i in 2:length(high_gender_women_data_residuals))
{
  high_gender_effect_women_feature_data_residuals <- base::merge(high_gender_effect_women_feature_data_residuals, high_gender_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(high_gender_effect_women_feature_data_residuals) <- c("eid", top_20_gender_features)
high_gender_effect_women_feature_data_residuals_no_id_residuals <- high_gender_effect_women_feature_data_residuals[,-1]

high_gender_effect_men_cor_residuals <- cor(high_gender_effect_men_feature_data_residuals_no_id, use = "pairwise.complete.obs")
high_gender_effect_women_cor_residuals <- cor(high_gender_effect_women_feature_data_residuals_no_id_residuals,use = "pairwise.complete.obs")
high_gender_effect_combined_correaltion_residuals <- high_gender_effect_men_cor_residuals
high_gender_effect_combined_correaltion_residuals[lower.tri(high_gender_effect_combined_correaltion_residuals)] <- high_gender_effect_women_cor_residuals[lower.tri(high_gender_effect_women_cor_residuals)]
```

```{r corrplot by familiy both genders all data}
corrplot(high_gender_effect_combined_correaltion_residuals, title="both genders - high gender effect", method = 'square', order = "alphabet",tl.cex = 0.1,tl.srt = 45)
```

### No gender effect data
```{r top gender affected features, include=FALSE}
no_gender_effect_features_residuals <- biobank_feature_residual_analysis[no_gender_effect_data]

no_gender_men_data_residuals <- lapply(no_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

no_gender_women_data_residuals <- lapply(no_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})

no_gender_effect_men_feature_data_residuals <- no_gender_men_data_residuals[[1]]
for(i in 2:length(no_gender_men_data_residuals))
{
  no_gender_effect_men_feature_data_residuals <- base::merge(no_gender_effect_men_feature_data_residuals, no_gender_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(no_gender_effect_men_feature_data_residuals) <- c("eid", top_20_gender_features)
no_gender_effect_men_feature_data_residuals_no_id <- no_gender_effect_men_feature_data_residuals[,-1]

no_gender_effect_women_feature_data_residuals <- no_gender_women_data_residuals[[1]]
for(i in 2:length(no_gender_women_data_residuals))
{
  no_gender_effect_women_feature_data_residuals <- base::merge(no_gender_effect_women_feature_data_residuals, no_gender_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(no_gender_effect_women_feature_data_residuals) <- c("eid", top_20_gender_features)
no_gender_effect_women_feature_data_residuals_no_id_residuals <- no_gender_effect_women_feature_data_residuals[,-1]

no_gender_effect_men_cor_residuals <- cor(no_gender_effect_men_feature_data_residuals, use = "pairwise.complete.obs")
no_gender_effect_women_cor_residuals <- cor(no_gender_effect_women_feature_data_residuals,use = "pairwise.complete.obs")
no_gender_effect_combined_correaltion_residuals <- no_gender_effect_men_cor_residuals
no_gender_effect_combined_correaltion_residuals[lower.tri(no_gender_effect_combined_correaltion_residuals)] <- no_gender_effect_women_cor_residuals[lower.tri(no_gender_effect_women_cor_residuals)]

corrplot(no_gender_effect_combined_correaltion_residuals, title="both genders - no gender effect", method = 'square', order = "alphabet",tl.cex = 0.1,tl.srt = 45)
```

## Compare pure types to exterem mixture
```{r compare features between pure types and equal probability}
MD_features_for_pure_types_vs_mixture <- c(grep("Mean MD", top_20_gender_features),
                 grep("mean MD", top_20_gender_features))
Volume_features_for_pure_types_vs_mixture <- c(grep("Volume", top_20_gender_features))
```

```{r volume features both data sets}
volume_features_residuals_for_comparison <- biobank_feature_residual_analysis[Volume_features_for_pure_types_vs_mixture]

no_gender_men_data_residuals <- lapply(no_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

no_gender_women_data_residuals <- lapply(no_gender_effect_features_residuals, function(x){x$hypothesis_results$mixture_model$women_responsebilities})

no_gender_effect_men_feature_data_residuals <- no_gender_men_data_residuals[[1]]
for(i in 2:length(no_gender_men_data_residuals))
{
  no_gender_effect_men_feature_data_residuals <- base::merge(no_gender_effect_men_feature_data_residuals, no_gender_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(no_gender_effect_men_feature_data_residuals) <- c("eid", top_20_gender_features)
no_gender_effect_men_feature_data_residuals_no_id <- no_gender_effect_men_feature_data_residuals[,-1]

no_gender_effect_women_feature_data_residuals <- no_gender_women_data_residuals[[1]]
for(i in 2:length(no_gender_women_data_residuals))
{
  no_gender_effect_women_feature_data_residuals <- base::merge(no_gender_effect_women_feature_data_residuals, no_gender_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(no_gender_effect_women_feature_data_residuals) <- c("eid", top_20_gender_features)
no_gender_effect_women_feature_data_residuals_no_id_residuals <- no_gender_effect_women_feature_data_residuals[,-1]

no_gender_effect_men_cor_residuals <- cor(no_gender_effect_men_feature_data_residuals, use = "pairwise.complete.obs")
no_gender_effect_women_cor_residuals <- cor(no_gender_effect_women_feature_data_residuals,use = "pairwise.complete.obs")
no_gender_effect_combined_correaltion_residuals <- no_gender_effect_men_cor_residuals
no_gender_effect_combined_correaltion_residuals[lower.tri(no_gender_effect_combined_correaltion_residuals)] <- no_gender_effect_women_cor_residuals[lower.tri(no_gender_effect_women_cor_residuals)]

corrplot(no_gender_effect_combined_correaltion_residuals, title="both genders - no gender effect", method = 'square', order = "alphabet",tl.cex = 0.1,tl.srt = 45)
```


## Anti diagonal
First select only FDR significant features from the antidiagonal: 
```{r filter FDR significant features antidiagonal, include=FALSE}
FDR_significant_features <- q2_q4_features_names
```

extract feature data:
```{r extract FDR significant features data, include=FALSE}
significant_features <- biobank_feature_residual_analysis[FDR_significant_features]

men_data <- lapply(significant_features, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

women_data <- lapply(significant_features, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

```{r partiton to features, include=FALSE}
FA_features <- c(grep("Mean FA", names(significant_features)),
                 grep("mean FA", names(significant_features)))
MD_features <- c(grep("Mean MD", names(significant_features)),
                 grep("mean MD", names(significant_features)))
Volume_features <- c(grep("Volume", names(significant_features)))
feature_order_for_corrplot <- c(FA_features, MD_features, Volume_features)
```

join the tables:
```{r create men table, include=FALSE, warning=FALSE}
men_feature_data <- men_data[[1]]
for(i in 2:length(men_data))
{
  men_feature_data <- base::merge(men_feature_data, men_data[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data) <- c("eid", FDR_significant_features)
men_features_no_id <- men_feature_data[,-1]
```

```{r create women table, include=FALSE, warning=FALSE}
women_feature_data <- women_data[[1]]
for(i in 2:length(women_data))
{
  women_feature_data <- base::merge(women_feature_data, women_data[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data) <- c("eid", FDR_significant_features)
women_features_no_id <- women_feature_data[,-1]
```

## Cohen D histogram

```{r cohen D for FDR significant features}
hist(sapply(significant_features, function(x){x$hypothesis_results$cohen_d_test$estimate}),xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")
```


## Correlation matrix
```{r correlation matrix by gender, include=FALSE}
men_cor <- cor(men_features_no_id[,feature_order_for_corrplot], use = "pairwise.complete.obs")
women_cor <- cor(women_features_no_id[,feature_order_for_corrplot],use = "pairwise.complete.obs")
combined_correaltion <- men_cor
combined_correaltion[lower.tri(combined_correaltion)] <- women_cor[lower.tri(women_cor)]
```


```{r corrplot by name both genders}
corrplot(combined_correaltion, order="alphabet", title="both genders",
         tl.cex = 0.1,tl.srt = 45)
```

```{r prepar corrplot index, include=FALSE}
FA_features_length <- length(FA_features)
MD_features_length <- length(MD_features)
Volume_features_length <- length(Volume_features)

FA_index <- 1:FA_features_length
MD_index <- (FA_features_length + 1):(FA_features_length + 1 + MD_features_length) 
Volume_index <- (FA_features_length + MD_features_length + 2):(length(names(significant_features))) 
```

```{r plot corrplot by regions}
corrplot(combined_correaltion[FA_index,FA_index], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45)  
corrplot(combined_correaltion[FA_index,FA_index], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "FPC")  
################################################################
corrplot(combined_correaltion[MD_index,MD_index], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45)  
corrplot(combined_correaltion[MD_index,MD_index], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "FPC")  
################################################################
corrplot(combined_correaltion[Volume_index,Volume_index], method="color", title="Volume",
         tl.cex = 0.4,tl.srt = 45)  
corrplot(combined_correaltion[Volume_index,Volume_index], method="color", title="Volume",
         tl.cex = 0.3,tl.srt = 45, order = "FPC")  
```



# Standardize data

## Pure types

In this section we compute corelation matrix for pure types features only
```{r pure types features log data, include=FALSE}
pure_type_features_for_correlation_analysis_names <- c(
  "Volume of grey matter in Frontal Pole (left)",
  "Volume of grey matter in Frontal Pole (right)",
  "Volume of grey matter in Heschl's Gyrus (includes H1 and H2) (left)",
  "Volume of grey matter in Inferior Temporal Gyrus, posterior division (left)",
  "Volume of grey matter in Planum Temporale (left)",
  "Volume of grey matter in Temporal Occipital Fusiform Cortex (right)"
)

pure_type_features_log <- biobank_feature_standard_analysis[t_test_data_log_data$Row.names]

pure_type_men_data_log <- lapply(pure_type_features_log, function(x){x$hypothesis_results$mixture_model$men_responsebilities})

pure_type_women_data_log <- lapply(pure_type_features_log, function(x){x$hypothesis_results$mixture_model$women_responsebilities})
```

join the tables
```{r create new responsebilities table all data, include=FALSE, warning=FALSE}
pure_type_men_feature_data_log <- pure_type_men_data_log[[1]]
for(i in 2:length(pure_type_men_data_log))
{
  pure_type_men_feature_data_log <- base::merge(pure_type_men_feature_data_log, pure_type_men_data_log[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_men_feature_data_log) <- c("eid", t_test_data_log_data$Row.names)
pure_type_men_feature_data_log_no_id <- pure_type_men_feature_data_log[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
pure_type_women_feature_data_log <- pure_type_women_data_log[[1]]
for(i in 2:length(pure_type_women_data_log))
{
  pure_type_women_feature_data_log <- base::merge(pure_type_women_feature_data_log, pure_type_women_data_log[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_women_feature_data_log) <- c("eid", t_test_data_log_data$Row.names)
pure_type_women_feature_data_log_no_id <- pure_type_women_feature_data_log[,-1]
```

```{r correlation matrix by gender pure types, include=FALSE}
pure_type_men_cor_log <- cor(pure_type_men_feature_data_log_no_id , use = "pairwise.complete.obs")
pure_type_women_cor_log <- cor(pure_type_women_feature_data_log_no_id ,use = "pairwise.complete.obs")
pure_type_combined_correaltion_log <- pure_type_men_cor_log
pure_type_combined_correaltion_log[lower.tri(pure_type_combined_correaltion_log)] <- pure_type_women_cor_log[lower.tri(pure_type_women_cor_log)]
```

```{r corrplot by name both genders all data}
corrplot(pure_type_combined_correaltion_log, title="both genders - full data", order = "alphabet",tl.cex = 0.5,tl.srt = 45)
```

## Full data

First select only FDR significant features from the antidiagonal: 
```{r filter FDR significant features all data, include=FALSE}
sig_level <- 0.1
FDR_significant_features_standard <- rownames(combined_df_long_sorted_standard)[
    with(combined_df_long_sorted_standard,(fdr_pv <= sig_level))]  
FDR_significant_features_standard <- na.omit(FDR_significant_features_standard)
```

extract feature data:
```{r extract FDR significant features all data, include=FALSE}
significant_features_standard <- biobank_feature_standard_analysis[FDR_significant_features_standard]

men_data_standard <- lapply(significant_features_standard, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

women_data_standard <- lapply(significant_features_standard, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

```{r partiton to features all data, include=FALSE}
FA_features_standard <- c(grep("Mean FA", names(significant_features_standard)),
                 grep("mean FA", names(significant_features_standard)))
MD_features_standard <- c(grep("Mean MD", names(significant_features_standard)),
                 grep("mean MD", names(significant_features_standard)))
Volume_features_standard <- c(grep("Volume", names(significant_features_standard)))
feature_order_for_corrplot_standard <- c(FA_features_standard, MD_features_standard, Volume_features_standard)
```

join the tables:
```{r create men table all data, include=FALSE, warning=FALSE}
men_feature_data_standard <- men_data_standard[[1]]
for(i in 2:length(men_data_standard))
{
  men_feature_data_standard <- base::merge(men_feature_data_standard, men_data_standard[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data_standard) <- c("eid", FDR_significant_features_standard)
men_features_no_id_standard <- men_feature_data_standard[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
women_feature_data_standard <- women_data_standard[[1]]
for(i in 2:length(women_data_standard))
{
  women_feature_data_standard <- base::merge(women_feature_data_standard, women_data_standard[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data_standard) <- c("eid", FDR_significant_features_standard)
women_features_no_id_standard <- women_feature_data_standard[,-1]
```

## Cohen D histogram

```{r cohen D for FDR significant features all data}
hist(sapply(significant_features_standard, function(x){x$hypothesis_results$cohen_d_test$estimate}),xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")
```


## Correlation matrix
```{r correlation matrix by gender all data, include=FALSE}
men_cor_standard <- cor(men_features_no_id_standard[,feature_order_for_corrplot_standard], use = "pairwise.complete.obs")
women_cor_standard <- cor(women_features_no_id_standard[,feature_order_for_corrplot_standard],use = "pairwise.complete.obs")
combined_correaltion_standard <- men_cor_standard
combined_correaltion_standard[lower.tri(combined_correaltion_standard)] <- women_cor_standard[lower.tri(women_cor_standard)]
```


```{r corrplot by name both genders all data}
corrplot(combined_correaltion_standard, order="alphabet", title="both genders - full data",
         tl.cex = 0.1,tl.srt = 45)
```

```{r corrplot by familiy both genders all data}
corrplot(combined_correaltion_standard[FA_features_standard,FA_features_standard], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_standard[MD_features_standard,MD_features_standard], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_standard[Volume_features_standard,Volume_features_standard], method="color", title="Volume",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
```



