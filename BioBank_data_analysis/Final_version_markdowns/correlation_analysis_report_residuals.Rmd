---
title: "Correlation analysis of responsebilites"
author: "Nitay Alon"
date: "May 17, 2019"
output: html_document
---

In the E-step of the EM algorithm we compute the above conditional probabilities. The first step is to extract these probabilities and create a new table of id and probabilities.

```{r load methods, include=FALSE}
# local_server_prefix <- "~/Documents/Human_brain_research/DAPHNA_JOEL/"
library(pbapply)
library(corrplot)
local_server_prefix <- "~/Human_brain_research/"
source(paste0(local_server_prefix,"BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/analyze_full_brain_feature.R"))
source(paste0(local_server_prefix,"BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/method_helper.R"))
# source(paste0(local_server_prefix,"BioBank_data_analysis/load_biobank_data.R"))
```

```{r load data, include=FALSE}
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_residual_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/biobank_feature_standard_analysis.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/combined_df_long_sorted_residuals.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/combined_df_long_sorted_standardize.RData")
load("~/Human_brain_research/BioBank_data_analysis/Final_data_for_analysis/colomns_name.RData")
```

# Residual data

## Pure types
In this section we compute corelation matrix for pure types features only
```{r pure types features, include=FALSE}
pure_type_features_residuals <- biobank_feature_residual_analysis[pure_types_residual_data_with_t_test$Row.names]

pure_type_men_data_residuals <- lapply(pure_type_features_residuals, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

pure_type_women_data_residuals <- lapply(pure_type_features_residuals, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

join the tables
```{r create new responsebilities table all data, include=FALSE, warning=FALSE}
pure_type_men_feature_data_residuals <- pure_type_men_data_residuals[[1]]
for(i in 2:length(pure_type_men_data_residuals))
{
  pure_type_men_feature_data_residuals <- base::merge(pure_type_men_feature_data_residuals, pure_type_men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_men_feature_data_residuals) <- c("eid", pure_types_residual_data_with_t_test$Row.names)
pure_type_men_feature_data_residuals_no_id_residuals <- pure_type_men_feature_data_residuals[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
pure_type_women_feature_data_residuals <- pure_type_women_data_residuals[[1]]
for(i in 2:length(pure_type_women_data_residuals))
{
  pure_type_women_feature_data_residuals <- base::merge(pure_type_women_feature_data_residuals, pure_type_women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_women_feature_data_residuals) <- c("eid", pure_types_residual_data_with_t_test$Row.names)
pure_type_women_features_no_id_residuals <- pure_type_women_feature_data_residuals[,-1]
```

```{r correlation matrix by gender pure types, include=FALSE}
pure_type_men_cor_residuals <- cor(pure_type_men_feature_data_residuals_no_id_residuals , use = "pairwise.complete.obs")
pure_type_women_cor_residuals <- cor(pure_type_women_features_no_id_residuals ,use = "pairwise.complete.obs")
pure_type_combined_correaltion_residuals <- pure_type_men_cor_residuals
pure_type_combined_correaltion_residuals[lower.tri(pure_type_combined_correaltion_residuals)] <- pure_type_women_cor_residuals[lower.tri(pure_type_women_cor_residuals)]
```

```{r corrplot by name both genders all data}
corrplot(pure_type_combined_correaltion_residuals, title="both genders - full data", order = "alphabet",
         tl.cex = 0.5,tl.srt = 45)
```

## Full data

First select only FDR significant features from the antidiagonal: 

```{r filter FDR significant features all data, include=FALSE}
sig_level <- 0.1
FDR_significant_features_residuals <- rownames(combined_df_long_sorted_residuals)[
    with(combined_df_long_sorted_residuals,(fdr_pv <= sig_level))]  
FDR_significant_features_residuals <- na.omit(FDR_significant_features_residuals)
```

extract feature data:

```{r extract FDR significant features all data, include=FALSE}
significant_features_residuals <- biobank_feature_residual_analysis[FDR_significant_features_residuals]

men_data_residuals <- lapply(significant_features_residuals, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

women_data_residuals <- lapply(significant_features_residuals, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

```{r partiton to features all data, include=FALSE}
FA_features_residuals <- c(grep("Mean FA", names(significant_features_residuals)),
                 grep("mean FA", names(significant_features_residuals)))
MD_features_residuals <- c(grep("Mean MD", names(significant_features_residuals)),
                 grep("mean MD", names(significant_features_residuals)))
Volume_features_residuals <- c(grep("Volume", names(significant_features_residuals)))
feature_order_for_corrplot_residuals <- c(FA_features_residuals, MD_features_residuals, Volume_features_residuals)
```

join the tables:
```{r create men table all data, include=FALSE, warning=FALSE}
men_feature_data_residuals <- men_data_residuals[[1]]
for(i in 2:length(men_data_residuals))
{
  men_feature_data_residuals <- base::merge(men_feature_data_residuals, men_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data_residuals) <- c("eid", FDR_significant_features_residuals)
men_features_no_id_residuals <- men_feature_data_residuals[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
women_feature_data_residuals <- women_data_residuals[[1]]
for(i in 2:length(women_data_residuals))
{
  women_feature_data_residuals <- base::merge(women_feature_data_residuals, women_data_residuals[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data_residuals) <- c("eid", FDR_significant_features_residuals)
women_features_no_id_residuals <- women_feature_data_residuals[,-1]
```

## Cohen D histogram

```{r cohen D for FDR significant features all data}
hist(sapply(significant_features, function(x){x$hypothesis_results$cohen_d_test$estimate}),xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")
```


## Correlation matrix

```{r correlation matrix by gender all data, include=FALSE}
men_cor_residuals <- cor(men_features_no_id_residuals[,feature_order_for_corrplot_residuals], use = "pairwise.complete.obs")
women_cor_residuals <- cor(women_features_no_id_residuals[,feature_order_for_corrplot_residuals],use = "pairwise.complete.obs")
combined_correaltion_residuals <- men_cor_residuals
combined_correaltion_residuals[lower.tri(combined_correaltion_residuals)] <- women_cor_residuals[lower.tri(women_cor_residuals)]
```




```{r corrplot by name both genders all data}
corrplot(combined_correaltion_residuals, title="both genders - full data", order = "alphabet",
         tl.cex = 0.1,tl.srt = 45)
```

```{r corrplot by eigenvalues both genders all data}
corrplot(combined_correaltion_residuals, title="both genders - full data", order = "FPC",
         tl.cex = 0.1,tl.srt = 45)
```

```{r corrplot by familiy both genders all data}
corrplot(combined_correaltion_residuals[FA_features_residuals,FA_features_residuals], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_residuals[MD_features_residuals,MD_features_residuals], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_residuals[Volume_features_residuals,Volume_features_residuals], method="color", title="Volume",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
```


## Anti diagonal
First select only FDR significant features from the antidiagonal: 
```{r filter FDR significant features antidiagonal, include=FALSE}
sig_level <- 0.01
FDR_significant_features <- rownames(combined_df_long_sorted_residuals)[
    with(combined_df_long_sorted_residuals,(fdr_pv <= sig_level & 
region == "Anti"))]  
FDR_significant_features <- na.omit(FDR_significant_features)
```

extract feature data:
```{r extract FDR significant features data, include=FALSE}
significant_features <- biobank_feature_residual_analysis[FDR_significant_features]

men_data <- lapply(significant_features, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

women_data <- lapply(significant_features, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

```{r partiton to features, include=FALSE}
FA_features <- c(grep("Mean FA", names(significant_features)),
                 grep("mean FA", names(significant_features)))
MD_features <- c(grep("Mean MD", names(significant_features)),
                 grep("mean MD", names(significant_features)))
Volume_features <- c(grep("Volume", names(significant_features)))
feature_order_for_corrplot <- c(FA_features, MD_features, Volume_features)
```

join the tables:
```{r create men table, include=FALSE, warning=FALSE}
men_feature_data <- men_data[[1]]
for(i in 2:length(men_data))
{
  men_feature_data <- base::merge(men_feature_data, men_data[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data) <- c("eid", FDR_significant_features)
men_features_no_id <- men_feature_data[,-1]
```

```{r create women table, include=FALSE, warning=FALSE}
women_feature_data <- women_data[[1]]
for(i in 2:length(women_data))
{
  women_feature_data <- base::merge(women_feature_data, women_data[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data) <- c("eid", FDR_significant_features)
women_features_no_id <- women_feature_data[,-1]
```

## Cohen D histogram

```{r cohen D for FDR significant features}
hist(sapply(significant_features, function(x){x$hypothesis_results$cohen_d_test$estimate}),xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")
```


## Correlation matrix
```{r correlation matrix by gender, include=FALSE}
men_cor <- cor(men_features_no_id[,feature_order_for_corrplot], use = "pairwise.complete.obs")
women_cor <- cor(women_features_no_id[,feature_order_for_corrplot],use = "pairwise.complete.obs")
combined_correaltion <- men_cor
combined_correaltion[lower.tri(combined_correaltion)] <- women_cor[lower.tri(women_cor)]
```


```{r corrplot by name both genders}
corrplot(combined_correaltion, order="alphabet", title="both genders",
         tl.cex = 0.1,tl.srt = 45)
```

```{r prepar corrplot index, include=FALSE}
FA_features_length <- length(FA_features)
MD_features_length <- length(MD_features)
Volume_features_length <- length(Volume_features)

FA_index <- 1:FA_features_length
MD_index <- (FA_features_length + 1):(FA_features_length + 1 + MD_features_length) 
Volume_index <- (FA_features_length + MD_features_length + 2):(length(names(significant_features))) 
```

```{r plot corrplot by regions}
corrplot(combined_correaltion[FA_index,FA_index], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45)  
corrplot(combined_correaltion[FA_index,FA_index], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "FPC")  
################################################################
corrplot(combined_correaltion[MD_index,MD_index], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45)  
corrplot(combined_correaltion[MD_index,MD_index], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "FPC")  
################################################################
corrplot(combined_correaltion[Volume_index,Volume_index], method="color", title="Volume",
         tl.cex = 0.4,tl.srt = 45)  
corrplot(combined_correaltion[Volume_index,Volume_index], method="color", title="Volume",
         tl.cex = 0.3,tl.srt = 45, order = "FPC")  
```



# Standardize data

## Pure types

In this section we compute corelation matrix for pure types features only
```{r pure types features log data, include=FALSE}
pure_type_features_log <- biobank_feature_standard_analysis[pure_types_log_data_with_t_test$Row.names]

pure_type_men_data_log <- lapply(pure_type_features_log, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

pure_type_women_data_log <- lapply(pure_type_features_log, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

join the tables
```{r create new responsebilities table all data, include=FALSE, warning=FALSE}
pure_type_men_feature_data_log <- pure_type_men_data_log[[1]]
for(i in 2:length(pure_type_men_data_log))
{
  pure_type_men_feature_data_log <- base::merge(pure_type_men_feature_data_log, pure_type_men_data_log[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_men_feature_data_log) <- c("eid", pure_types_log_data_with_t_test$Row.names)
pure_type_men_feature_data_log_no_id_log <- pure_type_men_feature_data_log[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
pure_type_women_feature_data_log <- pure_type_women_data_log[[1]]
for(i in 2:length(pure_type_women_data_log))
{
  pure_type_women_feature_data_log <- base::merge(pure_type_women_feature_data_log, pure_type_women_data_log[[i]], by.x = "eid", by.y = "eid")
}
names(pure_type_women_feature_data_log) <- c("eid", pure_types_log_data_with_t_test$Row.names)
pure_type_women_features_no_id_log <- pure_type_women_feature_data_log[,-1]
```

```{r correlation matrix by gender pure types, include=FALSE}
pure_type_men_cor_log <- cor(pure_type_men_feature_data_log_no_id_log , use = "pairwise.complete.obs")
pure_type_women_cor_log <- cor(pure_type_women_features_no_id_log ,use = "pairwise.complete.obs")
pure_type_combined_correaltion_log <- pure_type_men_cor_log
pure_type_combined_correaltion_log[lower.tri(pure_type_combined_correaltion_log)] <- pure_type_women_cor_log[lower.tri(pure_type_women_cor_log)]
```

```{r corrplot by name both genders all data}
corrplot(pure_type_combined_correaltion_log, title="both genders - full data", order = "alphabet",
         tl.cex = 0.5,tl.srt = 45)
```

## Full data

First select only FDR significant features from the antidiagonal: 
```{r filter FDR significant features all data, include=FALSE}
sig_level <- 0.1
FDR_significant_features_standard <- rownames(combined_df_long_sorted_standard)[
    with(combined_df_long_sorted_standard,(fdr_pv <= sig_level))]  
FDR_significant_features_standard <- na.omit(FDR_significant_features_standard)
```

extract feature data:
```{r extract FDR significant features all data, include=FALSE}
significant_features_standard <- biobank_feature_standard_analysis[FDR_significant_features_standard]

men_data_standard <- lapply(significant_features_standard, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$men_responsebilities})

women_data_standard <- lapply(significant_features_standard, function(x){x$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$women_responsebilities})
```

```{r partiton to features all data, include=FALSE}
FA_features_standard <- c(grep("Mean FA", names(significant_features_standard)),
                 grep("mean FA", names(significant_features_standard)))
MD_features_standard <- c(grep("Mean MD", names(significant_features_standard)),
                 grep("mean MD", names(significant_features_standard)))
Volume_features_standard <- c(grep("Volume", names(significant_features_standard)))
feature_order_for_corrplot_standard <- c(FA_features_standard, MD_features_standard, Volume_features_standard)
```

join the tables:
```{r create men table all data, include=FALSE, warning=FALSE}
men_feature_data_standard <- men_data_standard[[1]]
for(i in 2:length(men_data_standard))
{
  men_feature_data_standard <- base::merge(men_feature_data_standard, men_data_standard[[i]], by.x = "eid", by.y = "eid")
}
names(men_feature_data_standard) <- c("eid", FDR_significant_features_standard)
men_features_no_id_standard <- men_feature_data_standard[,-1]
```

```{r create women table all data, include=FALSE, warning=FALSE}
women_feature_data_standard <- women_data_standard[[1]]
for(i in 2:length(women_data_standard))
{
  women_feature_data_standard <- base::merge(women_feature_data_standard, women_data_standard[[i]], by.x = "eid", by.y = "eid")
}
names(women_feature_data_standard) <- c("eid", FDR_significant_features_standard)
women_features_no_id_standard <- women_feature_data_standard[,-1]
```

## Cohen D histogram

```{r cohen D for FDR significant features all data}
hist(sapply(significant_features_standard, function(x){x$hypothesis_results$cohen_d_test$estimate}),xlab = "Cohen-D", main = "Histogram of Cohen D", sub = "Residual data")
```


## Correlation matrix
```{r correlation matrix by gender all data, include=FALSE}
men_cor_standard <- cor(men_features_no_id_standard[,feature_order_for_corrplot_standard], use = "pairwise.complete.obs")
women_cor_standard <- cor(women_features_no_id_standard[,feature_order_for_corrplot_standard],use = "pairwise.complete.obs")
combined_correaltion_standard <- men_cor_standard
combined_correaltion_standard[lower.tri(combined_correaltion_standard)] <- women_cor_standard[lower.tri(women_cor_standard)]
```


```{r corrplot by name both genders all data}
corrplot(combined_correaltion_standard, order="alphabet", title="both genders - full data",
         tl.cex = 0.1,tl.srt = 45)
```

```{r corrplot by familiy both genders all data}
corrplot(combined_correaltion_standard[FA_features_standard,FA_features_standard], method="color", title="FA",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_standard[MD_features_standard,MD_features_standard], method="color", title="MD",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
corrplot(combined_correaltion_standard[Volume_features_standard,Volume_features_standard], method="color", title="Volume",
         tl.cex = 0.1,tl.srt = 45, order = "alphabet")  
```