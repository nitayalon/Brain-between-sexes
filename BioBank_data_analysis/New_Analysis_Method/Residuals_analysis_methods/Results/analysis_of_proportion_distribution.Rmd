---
title: "Exploring the distribution of gender proportions in mixture model"
author: "Nitay Alon"
date: "2/28/2019"
output: html_document
---

In this report we explore the joint distribution (structure) of the mixture proportions of brain features volumes. In the first section a short explanation on the meaning of the proportions is given followed by a set of plots exploring the structure of these variables. 

# Gender preference proprtions
The mixture model assumes that the distribution of each brain feature measures is a mixture of 2 underline normal distributions (assuming unequal variance and mean). Since the data is scaled one of those distributions will have a mean over 0 and the other one below it. 

In turn each gender "selects" the proportion of high mean distribution and low mean distribution, denoted $p,q$ in this report. The goal of this report is to explore the distribution of these proportions.

# Joint distribution of proportions:
```{r sourcing methods, warning=FALSE,include=FALSE}
library(ggplot2)
library(dplyr)

load("~/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/Results/New_analysis_method_results_normalized.RData")
source("~/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/convert_em_probs_to_pq_space.R")
source("~/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/merge_data_frames_by_column_names.R")

# load("/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/Results/New_analysis_method_results.RData")
# source("~/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/convert_em_probs_to_pq_space.R")
# source("~/HumanBrainResearch/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/merge_data_frames_by_column_names.R")

# load("~/Documents/Human_brain_research/DAPHNA_JOEL/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/Results/New_analysis_method_results_normalized.RData")
# source("~/Documents/Human_brain_research/DAPHNA_JOEL/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/convert_em_probs_to_pq_space.R")
# source("~/Documents/Human_brain_research/DAPHNA_JOEL/BioBank_data_analysis/New_Analysis_Method/Residuals_analysis_methods/merge_data_frames_by_column_names.R")

results_list_m_parameters <- convertEMProbabiltiesToPQSpace(results.list)

p_and_q <- sapply(results_list_m_parameters, function(x){c(x$p, x$q)})
```

### P-Value color schema pure vs mixture
First we add a colouring schema based on the *p-value* of the llrt, when the hypothesis is pure type vs mixture model. 
```{r pure type vs mixture model colouring schema, include=FALSE,warning=FALSE}
pvalue_per_feature <- pullPvaluePerHypothesis(results.list)
pvalue_per_feature_df <- t(pvalue_per_feature) %>% as.data.frame() 
p_and_q_df <- p_and_q %>% as.data.frame()
combined_df <- mergeDataFramesByColumnNames(pvalue_per_feature_df, p_and_q_df)
rownames(combined_df) <- c("p_values","p","q")
```

```{r pure type vs mixture model plotting with colors}
combined_df_long <- combined_df %>% t() %>% as.data.frame()
combined_df_long$bins_of_pv <- cut(combined_df_long$p_values, c(1e-9,1e-8,1e-3,1e-2,1))
ggplot(combined_df_long, aes(p,q, colour = bins_of_pv)) + 
  geom_point() + 
  ggtitle("Values of p and q", subtitle = "No correction")
```
### FDR
```{r fdr}
N <- nrow(combined_df_long)
combined_df_long_sorted <- combined_df_long[order(combined_df_long$p_values,decreasing = F),]
combined_df_long_sorted$n <- seq(1:N)
combined_df_long_sorted$fdr_p_value <- with(combined_df_long_sorted, p_values * N / n)
combined_df_long_sorted$bins_for_fdr <- cut(combined_df_long_sorted$fdr_p_value, c(0,1e-3,1e-1,10000))

ggplot(combined_df_long_sorted, aes(p,q, colour = bins_for_fdr)) + 
  geom_point() +
  geom_vline(xintercept = 0.5) +
  geom_hline(yintercept = 0.5) +
  ggtitle("Values of p and q", subtitle = "FDR correction") + 
  geom_abline(slope = 1, intercept = 0)
ggplot(combined_df_long_sorted, aes(p,q, colour = bins_for_fdr)) +  
  geom_point() + 
  ggtitle("Values of p and q", subtitle = "FDR correction") +
  geom_vline(xintercept = 0.5) + 
  geom_hline(yintercept = 0.5)
  
```

A visual inspection of the FDR coloring schema shows that the "region of discovery" are in the low-left and far-right corners. Plotting using the same colouring schema, but this time of the *logit* transformation

```{r plot p vs q log scale}
ggplot(combined_df_long_sorted, aes(log(p / (1-p)),log(q / (1-q)), colour = bins_for_fdr)) + geom_point() + 
  ggtitle("Values of logit(p) and logit(q)", subtitle = "FDR correction") + 
  theme_bw() + 
  xlab("p") + 
  ylab("q")
```

# Post hoc analysis

## Main diagonal
Analyzing the features based on the *p-values*:
```{r upper main diagonal features}
upper_main_diagonal_feature_names <- 
  rownames(combined_df_long_sorted)[
    with(combined_df_long_sorted,(p_values < 1e-3 & p > 0.5 & q > 0.5))]  
  
upper_main_diagonal_features <- 
  results.list[names(results.list) %in% upper_main_diagonal_feature_names]
```

Appling the same plotting schema as in the shiny app:
```{r plotting upper diagonal feature}
i <- 3
plotGenderHistogram(upper_main_diagonal_features[[i]], upper_main_diagonal_feature_names[i])
```

it is clear that in the case of the upper diagonal the mixture model yields higher likelihood ratio only due to right tailed observations.

### Non parametric LLRT
```{r non parametric llrt of main diagonal}
library(logcondens)
men_density <- logConDens()
```


## antidiagonal
Our interest lays in the antidiagonal. 

### Upper
```{r high q low p}
upper_antidiagonal_feature_names <- 
  rownames(combined_df_long_sorted)[
    with(combined_df_long_sorted,(p_values < 1e-3 & p < 0.5 & q > 0.5))]  
  
upper_antidiagonal_features <- 
  results.list[names(results.list) %in% upper_antidiagonal_feature_names]
```

```{r plotting upper anti diagonal feature}
i <- sample(1:length(upper_antidiagonal_feature_names), 1)
plotGenderHistogram(upper_antidiagonal_features[[i]], upper_antidiagonal_feature_names[i])
```

### Lower 
```{r low q high p}
lower_antidiagonal_feature_names <- 
  rownames(combined_df_long_sorted)[
    with(combined_df_long_sorted,(p_values < 1e-3 & p > 0.5 & q < 0.5))]  
  
lower_antidiagonal_features <- 
  results.list[names(results.list) %in% lower_antidiagonal_feature_names]
```

```{r plotting lower anti diagonal feature}
i <- sample(1:length(lower_antidiagonal_feature_names), 1)
plotGenderHistogram(lower_antidiagonal_features[[i]], lower_antidiagonal_feature_names[i])

tibble(p = lower_antidiagonal_features[[i]]$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$m_parameters$p,
       q = lower_antidiagonal_features[[i]]$hypothesis_results$pure_type_vs_mixed_gender_em_results$alternative_hypothesis$m_parameters$q)
```


```{r find interesting regions}
findInterestingRegion(lower_antidiagonal_features)
```

