---
title: "export tables for daphy"
author: "Nitay Alon"
date: "12/22/2019"
output: html_document
---

# First table
First we summarize for each non significant feature the following: Name, Cohen-D for log transformation, Cohen-D for residual analysis and double sided T-Test
```{r final residual data partition to tables, warning=FALSE}
library(dplyr)

pure_types_features_names <- row.names(pure_types_residual_model_table)

pure_types_residual_model_residual_table <-  combined_df_long_sorted_residuals[row.names(combined_df_long_sorted_residuals) %in% row.names(pure_types_residual_model_table),]

equal_probability_mixture_names <- combined_df_resid_equal_probs_sorted$feature[combined_df_resid_equal_probs_sorted$bh_pvalue > 0.05]
equal_mixture_model_types_residual_table <- combined_df_resid_equal_probs_sorted %>% 
  filter(feature %in% equal_probability_mixture_names)

non_equal_probability_mixture_names <- combined_df_resid_equal_probs_sorted$feature[combined_df_resid_equal_probs_sorted$bh_pvalue <= 0.05]
non_equal_mixture_model_types_residual_table <- combined_df_resid_equal_probs_sorted %>% 
  filter(feature %in% non_equal_probability_mixture_names)
```

```{r make three datasets table}
mosaic_mixture_model_features <- combined_df_resid_equal_probs_sorted[!combined_df_resid_equal_probs_sorted$p_equal_q,]
single_model_mosaic_mixture_model_features <- combined_df_resid_equal_probs_sorted[combined_df_resid_equal_probs_sorted$p_equal_q,]
```


```{r log data pure types, warning=FALSE}
pure_types_residual_model_log_table <- 
combined_df_long_sorted_standard[combined_df_long_sorted_standard$bins_for_fdr %in% levels(combined_df_long_sorted_standard$bins_for_fdr)[c(3,4)],] %>% 
  select(p_values, p, q, Cohen_D) 

log_volume_data_for_residual_pure_type <- 
combined_df_long_sorted_standard[rownames(combined_df_long_sorted_standard) %in% 
                                   rownames(pure_types_residual_model_residual_table),] %>% 
  select(p_values, p, q, Cohen_D) 

pure_types_residual_model_residual_table <- sapply(pure_types_residual_model_residual_data, function(x){
  c(x$mixture_model$m_parameters$p,
    x$mixture_model$m_parameters$q,
    x$hypothesis_results$cohen_d_test$estimate)
})

pure_types_residual_data <- base::merge(pure_types_residual_model_residual_table,
                                  log_volume_data_for_residual_pure_type, by = 0,
                                  all = TRUE,
                                  suffixes = c(".residual",".log"))


t_test_data <- sapply(biobank_feature_residual_analysis[rownames(pure_types_residual_model_table)], function(x){x$`hypothesis_results`$`t_test_for_difference_between_genders`$`p.value`}) %>% data.frame()
t_test_data$`Row.names` <- rownames(t_test_data)
pure_types_residual_data_with_t_test <- base::merge(pure_types_residual_data,
                                  t_test_data, by.x = 'Row.names', by.y = 'Row.names',
                                  all = TRUE)
names(pure_types_residual_data_with_t_test)[ncol(pure_types_residual_data_with_t_test)] <- 't_test_p_value'
pure_types_residual_data_with_t_test$adjusted_pv <- p.adjust(pure_types_residual_data_with_t_test$t_test_p_value, method = 'BH')

write.csv(pure_types_residual_data_with_t_test, file = "~/Human_brain_research/data_for_paper/pure_types_features_residual_data.csv", row.names = T)
```

```{r non significant log features table, warning=FALSE}
pure_types_log_model_log_table <- 
combined_df_long_sorted_standard[combined_df_long_sorted_standard$bins_for_fdr %in% levels(combined_df_long_sorted_standard$bins_for_fdr)[c(3,4)],] %>% 
  select(p_values, p, q, Cohen_D) 

pure_types_log_model_residual_table <- 
combined_df_long_sorted_residuals[rownames(pure_types_log_model_log_table),] %>% 
  select(p_values, p, q, Cohen_D) 

pure_types_log_data <- base::merge(pure_types_log_model_log_table,
                                  pure_types_log_model_residual_table, by = 0,
                                  all = TRUE,
                                  suffixes = c(".log",".residual"))

t_test_data_log_data <- sapply(biobank_feature_standard_analysis[rownames(pure_types_log_model_log_table)], function(x){x$`hypothesis_results`$`t_test_for_difference_between_genders`$`p.value`}) %>% data.frame()

t_test_data_log_data$`Row.names` <- rownames(t_test_data_log_data)
pure_types_log_data_with_t_test <- base::merge(pure_types_log_data,
                                  t_test_data_log_data, 
                                  by.x = 'Row.names', by.y='Row.names',
                                  all = TRUE)
names(pure_types_log_data_with_t_test)[ncol(pure_types_log_data_with_t_test)] <- 't_test_p_value'
pure_types_log_data_with_t_test$adjusted_pv <- p.adjust(pure_types_log_data_with_t_test$t_test_p_value, method = 'BH')

write.csv(pure_types_log_data_with_t_test, file = "pure_types_features_log_data.csv", row.names = T)
```


# Plots 

```{r selecting features for each analysis}
pure_types_volume_features <- pure_types_features_names[pure_types_features_names %>% grep("Volume", .)]

single_mixture_model_volume_features <- equal_probability_mixture_names[equal_probability_mixture_names %>% grep("Volume",.)]

two_mixture_model_volume_features <- non_equal_probability_mixture_names[non_equal_probability_mixture_names %>% grep("Volume",.)]
```

```{r full mixture model histograms}
i <- which(mosaic_mixture_model_features$feature_name == 'Volume of grey matter in Lingual Gyrus (left)')
plotGenderHistogram(biobank_standardized_data[[mosaic_mixture_model_features$feature_name[i]]],
  biobank_feature_standard_analysis[[mosaic_mixture_model_features$feature_name[i]]], mosaic_mixture_model_features$feature_name[i])

plotGenderHistogram(biobank_residuals_data[[mosaic_mixture_model_features$feature_name[i]]],
  biobank_feature_residual_analysis[[mosaic_mixture_model_features$feature_name[i]]], mosaic_mixture_model_features$feature_name[i])
```

```{r single mixture model histograms}
i <- which(single_mixture_model_volume_features == "Volume of grey matter in Occipital Fusiform Gyrus (left)")
plotGenderHistogram(biobank_standardized_data[[single_mixture_model_volume_features[i]]],
  biobank_feature_standard_analysis[[single_mixture_model_volume_features[i]]], 
  single_mixture_model_volume_features[i])

plotGenderHistogram(biobank_residuals_data[[single_mixture_model_volume_features[i]]],
  biobank_feature_residual_analysis[[single_mixture_model_volume_features[i]]], 
  single_mixture_model_volume_features[i])
```


```{r residual pure type with log data}
i <- which(pure_types_features_names == "Volume of grey matter in Postcentral Gyrus (left)")
plotGenderHistogram(biobank_standardized_data[[pure_types_features_names[i]]],
  biobank_feature_standard_analysis[[pure_types_features_names[i]]], pure_types_features_names[i])

plotGenderHistogram(biobank_residuals_data[[pure_types_features_names[i]]],
  biobank_feature_residual_analysis[[pure_types_features_names[i]]], pure_types_features_names[i])
```

Plotting 2 features side by side to see the mosiac 
```{r scatter plot of two features}
str(biobank_standardized_data[[volume_features_for_plot[1]]])
str(biobank_standardized_data[[volume_features_for_plot[2]]])
```

```{r correlation validation}
inner_join(biobank_standardized_data[[volume_features_for_plot[1]]],
        biobank_standardized_data[[volume_features_for_plot[2]]],
     by = 'eid') %>% 
  select(value.x, value.y) %>% 
  cor()
```


```{r scatter plot}
inner_join(biobank_standardized_data[[volume_features_for_plot[1]]],
        biobank_standardized_data[[volume_features_for_plot[5]]],
     by = 'eid') %>% 
  select(value.x, value.y, sex = sex.x) %>% 
  mutate(sex = factor(sex)) %>% 
ggplot(aes(value.x, value.y,color = sex)) + 
  geom_point(shape=20, size = 1, alpha = 1/2) +
  ggtitle("Volume") + 
  xlab(sprintf(volume_features_for_plot[1])) + 
  ylab(sprintf(volume_features_for_plot[5])) +
  coord_fixed() 
```

```{r scatter plot two probabilities}
scatter_plot_two_probabilities <- cbind(
rbind(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'),
     inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid')), c(rep(0,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'))), sex = rep(1,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid'))))) %>% data.frame()
names(scatter_plot_two_probabilities) = c('eid','responsebility.x', 'responsebility.y', 'sex')

ggplot(scatter_plot_two_probabilities, aes(responsebility.x, responsebility.y, col = factor(sex))) + 
  geom_point(shape=20, size = 1) + 
  coord_fixed(ratio = 1, xlim = c(0,1), ylim = c(0,1)) 
```

```{r scatter plot}
inner_join(biobank_standardized_data[[volume_features_for_plot[1]]],
        biobank_standardized_data[[volume_features_for_plot[2]]],
     by = 'eid') %>% 
  select(value.x, value.y, sex = sex.x) %>% 
  mutate(sex = factor(sex)) %>% 
ggplot(aes(value.x, value.y,color = sex)) + 
  geom_point(shape=1, size = 1) +
  ggtitle("Volume") + 
  xlab(sprintf(volume_features_for_plot[1])) + 
  ylab(sprintf(volume_features_for_plot[2])) +
  coord_fixed() 

```

```{r scatter plot two probabilities}
scatter_plot_two_probabilities <- cbind(
rbind(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'),
     inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid')), c(rep(0,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'))), sex = rep(1,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[1]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid'))))) %>% data.frame()
names(scatter_plot_two_probabilities) = c('eid','responsebility.x', 'responsebility.y', 'sex')

ggplot(scatter_plot_two_probabilities, aes(responsebility.x, responsebility.y, col = factor(sex))) + 
  geom_point(shape=1, size = 1) + 
  coord_fixed(ratio = 1, xlim = c(0,1), ylim = c(0,1)) 
```


```{r scatter plot}
inner_join(biobank_standardized_data[[volume_features_for_plot[2]]],
        biobank_standardized_data[[volume_features_for_plot[5]]],
     by = 'eid') %>% 
  select(value.x, value.y, sex = sex.x) %>% 
  mutate(sex = factor(sex)) %>% 
ggplot(aes(value.x, value.y,color = sex)) + 
  geom_point(shape=1, size = 1) +
  ggtitle("Volume") + 
  xlab(sprintf(volume_features_for_plot[2])) + 
  ylab(sprintf(volume_features_for_plot[5])) +
  coord_fixed() 

```


```{r scatter plot two probabilities}
scatter_plot_two_probabilities <- cbind(
rbind(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'),
     inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid')), c(rep(0,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$women_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$women_responsebilities,
     by = 'eid'))), sex = rep(1,nrow(inner_join(biobank_feature_residual_analysis[[volume_features_for_plot[5]]]$hypothesis_results$mixture_model$men_responsebilities,
        biobank_feature_residual_analysis[[volume_features_for_plot[2]]]$hypothesis_results$mixture_model$men_responsebilities,
     by = 'eid'))))) %>% data.frame()
names(scatter_plot_two_probabilities) = c('eid','responsebility.x', 'responsebility.y', 'sex')

ggplot(scatter_plot_two_probabilities, aes(responsebility.x, responsebility.y, col = factor(sex))) + 
  geom_point(shape=1, size = 1) + 
  coord_fixed(ratio = 1, xlim = c(0,1), ylim = c(0,1)) 
```